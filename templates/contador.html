<!DOCTYPE html>
<html>
<head>
    <title>Registro de Veh칤culos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .categoria-card {
            border-radius: 10px;
            background: #f4f6ff;
            padding: 12px;
            margin-bottom: 10px;
        }
        .btn-count {
            width: 45px;
        }
        .contador-num {
            font-size: 22px;
            font-weight: bold;
            color: #1f3c88;
            width: 60px;
            text-align: center;
        }
    </style>
</head>

<body class="bg-light">

<div class="container mt-4 mb-5">

    <h2 class="text-primary mb-3">Registro de Veh칤culos</h2>

    <h5><b>Usuario:</b> {{ session.usuario }} | <b>Ruta:</b> {{ session.ruta }}</h5>

    <hr>

    <h4 class="text-secondary mb-3">Categor칤as</h4>

    {% for c in categorias_base %}
    <div class="categoria-card shadow-sm">
        <div class="d-flex align-items-center justify-content-between">
            <b>{{ c }}</b>
            <div class="d-flex align-items-center">
                <button class="btn btn-danger btn-count me-2"
                        onclick="modificar('{{ c }}', 'restar')">-</button>

                <span id="cont_{{ c }}" class="contador-num">{{ conteos[c] }}</span>

                <button class="btn btn-primary btn-count ms-2"
                        onclick="modificar('{{ c }}', 'sumar')">+</button>
            </div>
        </div>
    </div>
    {% endfor %}

    <hr>

    <h4 class="text-secondary mb-3">A침adir nueva categor칤a</h4>

    <div class="input-group mb-3">
        <input id="newcat" type="text" class="form-control" placeholder="Nombre nueva categor칤a">
        <button class="btn btn-primary" onclick="agregarCategoria()">Agregar</button>
    </div>

    <div id="nuevasCategorias">
        {% for c, n in nuevas.items() %}
        <div class="categoria-card shadow-sm">
            <div class="d-flex align-items-center justify-content-between">
                <b>{{ c }} <span class="text-muted">(nuevo)</span></b>
                <div class="d-flex align-items-center">
                    <button class="btn btn-danger btn-count me-2"
                            onclick="modificar('{{ c }}', 'restar')">-</button>
                    <span id="cont_{{ c }}" class="contador-num">{{ n }}</span>
                    <button class="btn btn-primary btn-count ms-2"
                            onclick="modificar('{{ c }}', 'sumar')">+</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr class="mt-4">

    <div class="text-center d-flex justify-content-center gap-3 flex-wrap">
        <button class="btn btn-success btn-lg" onclick="guardarDatos()">Guardar Datos</button>
        <button class="btn btn-primary btn-lg" onclick="descargarExcel()">Descargar Excel</button>
        <button class="btn btn-danger btn-lg" onclick="cerrarSesion()">Cerrar Sesi칩n</button>
    </div>

    <div id="msg" class="text-center mt-3"></div>
</div>

<script>
function modificar(cat, accion) {
    fetch("/modificar", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `categoria=${encodeURIComponent(cat)}&accion=${accion}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            let el = document.getElementById("cont_" + cat);
            let num = parseInt(el.innerText);
            if (accion === "sumar") num++;
            if (accion === "restar" && num > 0) num--;
            el.innerText = num;
        }
    });
}

function agregarCategoria() {
    let nombre = document.getElementById("newcat").value.trim();
    if (!nombre) return alert("Debe escribir un nombre");

    fetch("/nueva_categoria", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `nombre=${encodeURIComponent(nombre)}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) return alert(data.error);
        location.reload();
    });
}

function guardarDatos() {
    if (!confirm("쯉eguro que deseas guardar los datos?")) return;

    fetch("/guardar", {method: "POST"})
    .then(r => r.json())
    .then(data => {
        document.getElementById("msg").innerHTML =
            `<div class="alert alert-success">${data.mensaje}</div>`;
        document.querySelectorAll(".contador-num").forEach(c => c.innerText = "0");
    });
}

/* 游댮 CAMBIO CLAVE AQU칈 */
function cerrarSesion() {
    if (!confirm("쯉eguro que deseas cerrar sesi칩n y enviar el correo?")) return;

    fetch("/cerrar", { method: "POST" })
        .then(r => r.json())
        .then(data => {
            document.getElementById("msg").innerHTML =
                `<div class="alert ${data.ok ? "alert-success" : "alert-danger"}">
                    ${data.mensaje}
                 </div>`;

            if (data.ok) {
                setTimeout(() => window.location.href = "/", 2000);
            }
        })
        .catch(() => {
            alert("Error de conexi칩n con el servidor");
        });
}

function descargarExcel() {
    window.open("/abrir_excel", "_blank");
}
</script>

</body>
</html>
